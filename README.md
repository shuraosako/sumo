# 🚗 AV車・ガソリン車混合交通シミュレーション（v2.4）

このシステムは、自動運転車（AV車）とガソリン車の混合交通シミュレーションを実行し、**CO2排出量・停止回数分析**に加えて、**AV車の信号先読み予測と自動速度制御**を実現する先進的な統合監視ツールです。

## 🎯 新機能（v2.4の特徴）

- **🤖 AV信号先読み予測**: AV車が道路進入時に次の交差点の信号タイミング（S, R, L, G）を自動予測
- **🚙 自動速度制御**: 信号タイミングに基づくAV車の最適速度計算・適用（Green Wave実現）
- **🔄 AV普及率制御**: 0-100%の範囲でAV車の普及率を設定可能
- **🎨 車両色分け**: 赤色（ガソリン車）、緑色（AV車）で視覚的に識別
- **📊 CO2排出量測定**: リアルタイムCO2排出量測定
- **🚦 停止回数分析**: 全道路での車両停止回数測定
- **⚡ 動的車両制御**: シミュレーション中の車両数とAV普及率維持
- **📈 統合レポート**: 4つの機能すべてを1回のシミュレーションで分析

---

## 🚀 クイックスタート

### Windows での実行:
```batch
cd monitoring
.\run_integrated_monitor.bat
```

#### 実行手順:
1. **AV普及率設定** (0-100%)
2. **車両数設定** (1-1000台)
3. **実行方法選択**:
   - `[1]` SUMO-GUI で可視化実行（手動制御 + 動的車両制御）
   - `[2]` **統合分析実行** (CO2+停止+AV制御+信号予測 同時実行) ← **推奨**

---

## 🎨 車両の特徴と制御

| 車両タイプ | 色 | 特徴 | CO2排出 | 速度制御 |
|-----------|---|------|---------|----------|
| **AV車（自動運転車）** | 🟢 **緑色** | 信号予測・自動速度調整 | **ゼロ排出** | **🤖 AI制御** |
| **ガソリン車（一般車両）** | 🔴 **赤色** | 人間らしい運転 | **CO2排出あり** | 手動運転 |

### 🤖 AV車の信号予測システム

AV車が道路（1, 2, ..., 12, -1, -2, ..., -12）に進入すると：

1. **🎯 信号タイミング予測**:
   - **S**: 青信号までの残り時間（秒）
   - **R**: 赤信号までの残り時間（秒）
   - **L**: 現在レーンの長さ（メートル）
   - **G**: 青信号の設定時間（秒）

2. **⚡ 最適速度計算**: 
   ```
   P = AV普及率, C = 90秒（サイクル長）
   T = G × P（閾値）
   
   if R ≤ T: V = 60 km/h（法定速度）
   elif (L/S)×3.6 ≤ 60: V = (L/S)×3.6（青にジャスト）
   elif (L/R)×3.6 ≤ 60: V = 60 km/h（法定速度）
   else: V = (L/(S+C))×3.6（次の青にジャスト）
   ```

3. **🚙 速度適用**: 計算されたVでAV車の速度をリアルタイム制御

---

## 📊 出力結果

### 📁 保存先: `data/log/`フォルダ

| ファイル名 | 内容 | 形式 | 新機能 |
|-----------|------|------|--------|
| `co2_emission_report.txt` | CO2排出量サマリーレポート | テキスト | ✅ |
| `co2_emission_log.csv` | CO2時系列詳細データ | CSV | ✅ |
| `stop_count_results.txt` | 停止回数分析結果 | テキスト | ✅ |
| `stop_count_detailed.csv` | 停止イベント詳細ログ | CSV | ✅ |
| `av_signal_results.txt` | **AV信号予測統計レポート** | テキスト | **🆕** |
| `av_signal_predictions.csv` | **AV信号予測・速度制御ログ** | CSV | **🆕** |

### 📈 出力例

#### CO2排出量レポート
```
============================================================
CO2排出量測定結果レポート（統合監視・AV信号予測機能付き）
============================================================
📊 車両タイプ別排出量:
   🔴 ガソリン車総排出量: 1250.45 g
   🟢 AV車総排出量: 0.00 g
   📈 全体総排出量: 1250.45 g

🤖 AV信号予測統計:
   総予測回数: 89
   監視対象道路: 24個
   平均S(青まで): 18.3秒
   平均R(赤まで): 35.7秒
   平均L(レーン長): 95.8メートル
   平均G(青時間): 28.5秒
   追跡済み車両-道路組合せ: 127
============================================================
```

#### 🆕 AV信号予測・速度制御ログ
```csv
time,vehicle_id,current_edge,signal_id,time_to_green,time_to_red,lane_length,green_duration,optimal_speed,previous_speed,speed_change,current_speed_ms
120.0,av_007,5,J0,23.5,45.2,120.5,30.0,42.5,35.2,7.3,11.8
125.0,av_012,2,1682382343,15.2,8.7,85.3,25.0,60.0,58.5,1.5,16.7
```

#### 🆕 リアルタイム制御表示
```
🚙 AV制御: av_007 道路5(正方向) → (35.2→42.5km/h) S:23.5s R:45.2s
🚙 AV制御: av_012 道路2(正方向) → (60.0km/h維持) S:15.2s R:8.7s
```

---

## 🧪 実験パターン例

### 🔬 AV普及率と信号制御効果の調査

```batch
# 実験1: ガソリン車のみ (AV普及率0% → 信号制御なし)
AV普及率: 0
車両数: 100
結果予測: 高いCO2排出量、多い停止回数

# 実験2: AV車50% (半分が信号制御あり)
AV普及率: 50  
車両数: 100
結果予測: 中程度のCO2削減、停止回数減少

# 実験3: AV車のみ (AV普及率100% → 完全信号制御)
AV普及率: 100
車両数: 100
結果予測: 最大CO2削減、最少停止回数（Green Wave効果）
```

### 📈 信号制御パラメータの影響調査

```batch
# 低密度での信号制御効果
車両数: 50, AV普及率: 100

# 中密度での信号制御効果  
車両数: 100, AV普及率: 100

# 高密度での信号制御効果
車両数: 200, AV普及率: 100
```

---

## 📁 ファイル構成（v2.4）

```
monitoring/
├── integrated_monitor.py           # 🆕 統合監視メインシステム（AV信号予測+速度制御）
├── monitoring_config.py            # 🆕 統合設定ファイル（AV設定含む）
├── debug_signal_ids.py             # 🆕 信号機ID調査ツール
│
├── run_integrated_monitor.bat      # Windows実行バッチファイル
│
config/
├── mixed_traffic.sumocfg           # SUMO設定ファイル
├── vehicle_types.xml               # 車両タイプ定義
├── mixed_routes.rou.xml            # 車両ルートファイル（自動生成）
└── 3gousen_new.net.xml            # 道路ネットワークファイル
│
data/
└── log/                           # 結果保存フォルダ
    ├── co2_emission_report.txt          # CO2サマリーレポート
    ├── co2_emission_log.csv             # CO2詳細ログ
    ├── stop_count_results.txt           # 停止回数結果
    ├── stop_count_detailed.csv          # 停止イベント詳細
    ├── av_signal_results.txt            # 🆕 AV信号予測統計
    └── av_signal_predictions.csv        # 🆕 AV信号予測・速度制御ログ
```

---

## 🔧 システム設定のカスタマイズ

### AV信号予測設定（monitoring_config.py）

```python
class AVSignalConfig:
    # 監視対象道路ID
    TARGET_ROAD_EDGES = ["1", "2", ..., "12", "-1", "-2", ..., "-12"]
    
    # 予測チェック間隔
    CHECK_INTERVAL = 1.0  # 秒
    
    # リアルタイム表示
    SHOW_REAL_TIME_PREDICTIONS = True
    
    # 信号方向設定
    DEFAULT_POSITIVE_SIGNAL_INDEX = 0  # 正方向
    DEFAULT_NEGATIVE_SIGNAL_INDEX = 2  # 逆方向
```

### 車両タイプ特性

| パラメータ | ガソリン車 | AV車 | 説明 |
|-----------|----------|------|------|
| 加速度 | 2.6 m/s² | 2.0 m/s² | 最大加速度 |
| 減速度 | 4.5 m/s² | 4.0 m/s² | 最大減速度 |
| 運転精度 | sigma=0.5 | sigma=0.0 | 完璧度（0=完璧） |
| 最高速度 | 50 m/s | 50 m/s | 制限速度 |
| CO2排出 | HBEFA3/PC_G_EU4 | ゼロ排出 | 排出クラス |
| **速度制御** | **なし** | **🤖 AI制御** | **信号予測ベース** |

---

## 🐛 トラブルシューティング

### よくある問題と解決方法

#### 1. 信号機ID取得エラー
```
⚠️ 信号方向取得エラー J5: Traffic light 'J5' is not known
```
**解決方法:**
```bash
# 信号機ID調査ツールで実際のIDを確認
python debug_signal_ids.py
```

#### 2. ゼロ除算エラー（速度計算）
```
❌ エラーが発生しました: float division by zero
```
**解決方法:**
- v2.4では自動的にガード条件で法定速度にフォールバック
- 信号情報が不正な場合の警告メッセージを確認

#### 3. レーン長取得エラー
```
⚠️ エッジ-7の長さ取得エラー: 'EdgeDomain' object has no attribute 'getLength'
```
**解決方法:**
- v2.4では `traci.lane.getLength()` を使用（修正済み）

#### 4. SUMO環境変数設定
```bash
# Windows
set SUMO_HOME=C:\Program Files (x86)\Eclipse\Sumo

# PowerShell  
$env:SUMO_HOME = "C:\Program Files (x86)\Eclipse\Sumo"
```

---

## 📈 データ活用

### Excel分析（AV信号制御効果）
1. `av_signal_predictions.csv`をExcelで開く
2. 最適速度と実際速度の差をグラフ化
3. 信号予測精度（S, R値）の分析
4. Green Wave効果の可視化

### Python分析（信号制御効果）
```python
import pandas as pd
import matplotlib.pyplot as plt

# AV信号予測結果の読み込み
df = pd.read_csv('data/log/av_signal_predictions.csv')

# 速度制御効果の分析
plt.figure(figsize=(12, 6))

# 最適速度vs実際速度
plt.subplot(1, 2, 1)
plt.scatter(df['previous_speed'], df['optimal_speed'])
plt.xlabel('制御前速度 (km/h)')
plt.ylabel('最適速度 (km/h)')
plt.title('AV車速度制御効果')

# 信号予測時間の分布
plt.subplot(1, 2, 2)
plt.hist(df['time_to_green'], bins=30, alpha=0.7, label='S (青まで)')
plt.hist(df['time_to_red'], bins=30, alpha=0.7, label='R (赤まで)')
plt.xlabel('時間 (秒)')
plt.ylabel('頻度')
plt.legend()
plt.title('信号予測時間分布')

plt.tight_layout()
plt.show()

# Green Wave効果の定量評価
print(f"平均速度制御幅: {df['speed_change'].abs().mean():.1f} km/h")
print(f"平均信号待ち予測時間: {df['time_to_green'].mean():.1f} 秒")
```

---

## 💡 研究・応用例

### 🔬 学術研究テーマ
- **Green Wave効果の定量評価**: AV普及率と交通流効率の関係
- **CO2削減効果分析**: 信号制御による環境負荷軽減
- **混合交通最適化**: ガソリン車とAV車の最適混合比率
- **信号制御アルゴリズム評価**: 異なる速度決定式の比較

### 🏛️ 政策立案支援
- **AV導入政策効果予測**: 段階的AV普及のシミュレーション
- **交通インフラ投資効果**: 信号機高度化の費用対効果
- **環境政策評価**: CO2削減目標達成のためのAV普及率設定

### 🏢 産業応用
- **自動運転システム開発**: 信号予測アルゴリズムの検証
- **交通管理システム**: リアルタイム交通制御の最適化
- **環境コンサルティング**: 交通由来CO2削減戦略の立案

---

## 🎓 システムバージョン履歴

| バージョン | 主な機能 | 実装日 |
|-----------|---------|-------|
| v1.0 | 基本CO2測定・停止回数分析 | 初期版 |
| v2.0 | 動的車両制御追加 | 機能拡張 |
| v2.1 | AV信号予測機能追加 | 信号機能 |
| v2.2 | S+R値予測対応 | 予測拡張 |
| v2.3 | L+G値追加（4値予測） | 情報充実 |
| **v2.4** | **AV自動速度制御実装** | **完全版** |

---

## 📝 ライセンス

このプロジェクトはMITライセンスの下で提供されています。研究・教育・商用利用すべてに対応。

---

**🎯 統合監視システム v2.4 - AV車の未来交通を今すぐ体験！**