# 🚗 AV車・ガソリン車混合交通シミュレーション

このシステムは、自動運転車（AV車）とガソリン車の混合交通シミュレーションを実行し、CO2排出量と停止回数を統合分析するツールです。

## 🎯 特徴

- **🔄 AV普及率制御**: 0-100%の範囲でAV車の普及率を設定可能
- **🎨 車両色分け**: 赤色（ガソリン車）、緑色（AV車）で視覚的に識別
- **📊 CO2排出量測定**: ガソリン車のリアルタイムCO2排出量測定
- **🚦 停止回数分析**: 指定エリアでの車両停止回数測定
- **📈 統合レポート**: CO2排出量と停止回数の統合分析結果
- **📁 結果保存**: `data/log/`フォルダに全結果を整理保存

---

## 🚀 クイックスタート

### Windows での実行:
```batch
.\.\run_simulation.bat
```

#### 実行手順:
1. **AV普及率設定** (0-100%)
2. **車両数設定** (1-1000台)
3. **実行方法選択**:
   - `[1]` CO2排出量測定のみ
   - `[2]` **統合分析実行** (CO2測定 + 停止回数分析) ← **推奨**
   - `[3]` 停止回数測定のみ

---

## 🎨 車両の色分け

| 車両タイプ | 色 | 特徴 | CO2排出 |
|-----------|---|------|---------|
| **AV車（自動運転車）** | 🟢 **緑色** | 完璧な運転、スムーズな動き | **ゼロ排出** |
| **ガソリン車（一般車両）** | 🔴 **赤色** | 人間らしい運転、若干不規則 | **CO2排出あり** |

---

## 📊 出力結果

### 📁 保存先: `data/log/`フォルダ

| ファイル名 | 内容 | 形式 |
|-----------|------|------|
| `co2_emission_report.txt` | CO2排出量サマリーレポート | テキスト |
| `co2_emission_log.csv` | CO2時系列詳細データ | CSV |
| `stop_count_results.txt` | 停止回数分析結果 | テキスト |
| `stop_count_detailed.csv` | 停止イベント詳細ログ | CSV |
| `integrated_results.csv` | 統合分析結果 | CSV |

### 📈 出力例

#### CO2排出量レポート
```
============================================================
CO2排出量測定結果レポート
============================================================
📊 車両タイプ別排出量:
   🔴 ガソリン車総排出量: 1250.45 g
   🟢 AV車総排出量: 0.00 g
   📈 全体総排出量: 1250.45 g

💨 ガソリン車CO2排出率: 142.3 g/km
📊 【論文パラメータ】
   AV普及率 (p): 0.500
   総車両数: 100
============================================================
```

#### 停止回数分析結果
```
🛑 停止分析結果:
   総停止回数: 516 回
   停止発生エッジ数: 34/48 個
   エッジあたり平均: 10.75 回
   車両あたり平均: 5.16 回
```

---

## 🧪 実験パターン例

### 🔬 AV普及率の影響調査

```batch
# 実験1: ガソリン車のみ (AV普及率0%)
AV普及率: 0
車両数: 100
実行方法: [2] 統合分析実行

# 実験2: AV車50%
AV普及率: 50  
車両数: 100
実行方法: [2] 統合分析実行

# 実験3: AV車のみ (AV普及率100%)
AV普及率: 100
車両数: 100
実行方法: [2] 統合分析実行
```

### 📈 交通量の影響調査

```batch
# 低密度: 50台
車両数: 50
AV普及率: 50

# 中密度: 100台  
車両数: 100
AV普及率: 50

# 高密度: 200台
車両数: 200
AV普及率: 50
```

---

## 📁 ファイル構成

```
project_root/
├── run_simulation.bat              # メイン実行バッチファイル
├── generate_mixed_traffic.py       # 車両ルート生成スクリプト
├── fixed_co2_monitor.py            # CO2排出量測定スクリプト
├── fixed_stop_counter.py           # 停止回数分析スクリプト
├── integrated_results_display.py   # 統合結果表示スクリプト
├── mixed_traffic.sumocfg           # SUMO設定ファイル
├── routes.rou.xml                  # 車両ルートファイル（自動生成）
├── 3gousen_new.net.xml            # 道路ネットワークファイル
│
└── data/                          # データフォルダ
    └── log/                       # 結果保存フォルダ
        ├── co2_emission_report.txt      # CO2サマリーレポート
        ├── co2_emission_log.csv         # CO2詳細ログ
        ├── stop_count_results.txt       # 停止回数結果
        ├── stop_count_detailed.csv      # 停止イベント詳細
        └── integrated_results.csv       # 統合分析結果
```

---

## 🔧 設定のカスタマイズ

### 車両タイプ特性

| パラメータ | ガソリン車 | AV車 | 説明 |
|-----------|----------|------|------|
| 加速度 | 2.6 m/s² | 2.0 m/s² | 最大加速度 |
| 減速度 | 4.5 m/s² | 4.0 m/s² | 最大減速度 |
| 運転精度 | sigma=0.5 | sigma=0.0 | 完璧度（0=完璧） |
| 最高速度 | 50 m/s | 50 m/s | 制限速度 |
| CO2排出 | HBEFA3/PC_G_EU4 | ゼロ排出 | 排出クラス |

---

## 🐛 トラブルシューティング

### よくある問題と解決方法

#### 1. SUMO_HOME環境変数が設定されていない
```bash
# Windows
set SUMO_HOME=C:\Program Files (x86)\Eclipse\Sumo

# または PowerShell
$env:SUMO_HOME = "C:\Program Files (x86)\Eclipse\Sumo"
```

#### 2. ファイルアクセスエラー
```
PermissionError: プロセスはファイルにアクセスできません
```
**解決方法:**
- SUMO-GUIが開いていたら閉じる
- 既存のルートファイルを削除: `del routes.rou.xml`

#### 3. 車両が表示されない
**解決方法:**
- ネットワークファイル `3gousen_new.net.xml` の存在確認
- シミュレーション時間を確認（車両生成に時間がかかる場合あり）
- AV普及率と車両数の設定を確認

#### 4. 結果ファイルが古いまま固定される
**解決方法:**
- `data/log/`フォルダ内の古いファイルを削除
- 修正版スクリプト（`fixed_`で始まるファイル）を使用していることを確認

---

## 📈 データ活用

### Excel分析
1. `data/log/integrated_results.csv`をExcelで開く
2. AV普及率とCO2排出量の関係をグラフ化
3. 停止回数との相関分析

### Python分析
```python
import pandas as pd
import matplotlib.pyplot as plt

# 統合結果の読み込み
df = pd.read_csv('data/log/integrated_results.csv')

# AV普及率とCO2排出量の関係をプロット
plt.scatter(df['av_penetration'], df['total_co2'])
plt.xlabel('AV普及率 (%)')
plt.ylabel('CO2排出量 (g)')
plt.title('AV普及率とCO2排出量の関係')
plt.show()
```

---

## 💡 応用例

- **環境負荷分析**: AV普及率とCO2排出量の関係
- **交通効率分析**: AV普及率と停止回数の関係  
- **政策効果分析**: AV導入政策のシミュレーション
- **学術研究**: 混合交通システムの定量的分析

---

## 📝 ライセンス

このプロジェクトはMITライセンスの下で提供されています。